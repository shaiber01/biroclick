{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "progress_schema.json",
  "title": "Paper Reproduction Progress",
  "description": "Schema for _artifact_progress.json files (artifact naming: underscore prefix indicates output-only)",
  
  "type": "object",
  "required": ["paper_id", "stages"],
  
  "properties": {
    "paper_id": {
      "type": "string",
      "description": "Unique identifier for the paper"
    },
    
    "total_runtime_seconds": {
      "type": "number",
      "default": 0,
      "description": "Total computation time spent"
    },
    
    "stages": {
      "type": "array",
      "description": "Progress for each stage. Array maintains execution order and matches code structure in state.py.",
      "items": {
        "$ref": "#/definitions/stage_progress"
      }
    },
    
    "discrepancy_summary": {
      "type": "object",
      "description": "Summary of all discrepancies across stages",
      "properties": {
        "total_discrepancies": {
          "type": "integer",
          "description": "Total number of discrepancies logged"
        },
        "blocking_discrepancies": {
          "type": "integer",
          "description": "Number of blocking discrepancies"
        },
        "systematic_shifts_identified": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Known systematic shifts that affect multiple results"
        }
      }
    },
    
    "user_interactions": {
      "type": "array",
      "description": "Log of all user decisions and feedback during reproduction",
      "items": {
        "$ref": "#/definitions/user_interaction"
      }
    }
  },
  
  "definitions": {
    "stage_progress": {
      "type": "object",
      "description": "Progress for a single stage.",
      "required": ["stage_id", "stage_type", "status", "last_updated", "summary"],
      "properties": {
        "stage_id": {
          "type": "string",
          "description": "Unique stage identifier matching plan stage_id (e.g., 'stage0_material_validation')"
        },
        "stage_type": {
          "type": "string",
          "enum": ["MATERIAL_VALIDATION", "SINGLE_STRUCTURE", "ARRAY_SYSTEM", "PARAMETER_SWEEP", "COMPLEX_PHYSICS"],
          "description": "Stage type from plan, used for validation hierarchy computation"
        },
        "status": {
          "type": "string",
          "enum": ["not_started", "in_progress", "completed_success", "completed_partial", "completed_failed", "blocked", "needs_rerun", "invalidated"],
          "description": "Current status of the stage. 'needs_rerun' = backtrack target, 'invalidated' = results invalid due to backtrack"
        },
        "invalidation_reason": {
          "type": ["string", "null"],
          "description": "Why this stage was invalidated (if status is 'invalidated' or 'needs_rerun')"
        },
        "last_updated": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of last update"
        },
        "revision_count": {
          "type": "integer",
          "default": 0,
          "description": "Number of design/analysis revisions"
        },
        "runtime_seconds": {
          "type": "number",
          "description": "Computation time for this stage"
        },
        "summary": {
          "type": "string",
          "description": "Brief summary of stage status"
        },
        "outputs": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/output"
          },
          "description": "Files produced by this stage"
        },
        "discrepancies": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/discrepancy"
          },
          "description": "Documented discrepancies from paper"
        },
        "issues": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Known issues or limitations"
        },
        "next_actions": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Recommended next steps"
        }
      }
    },
    
    "NOTE": "Figure comparisons are stored at the top-level in ReproState (not per-stage) for simpler management. Each FigureComparison has a stage_id field to link it to its source stage. See schemas/state.py for the canonical FigureComparison type.",
    
    "output": {
      "type": "object",
      "required": ["type", "filename", "description"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["data", "plot", "log"],
          "description": "Type of output"
        },
        "filename": {
          "type": "string",
          "description": "Output filename"
        },
        "description": {
          "type": "string",
          "description": "What the output contains"
        },
        "target_figure": {
          "type": ["string", "null"],
          "description": "Paper figure this output corresponds to"
        },
        "result_status": {
          "type": "string",
          "enum": ["success", "partial", "failure"],
          "description": "Reproduction quality for this output"
        },
        "comparison_notes": {
          "type": "string",
          "description": "Notes on comparison to paper"
        }
      }
    },
    
    "discrepancy": {
      "type": "object",
      "required": ["id", "figure", "quantity", "paper_value", "simulation_value", "classification"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique discrepancy ID (e.g., 'D1')"
        },
        "figure": {
          "type": "string",
          "description": "Target figure ID"
        },
        "quantity": {
          "type": "string",
          "description": "What quantity differs (e.g., 'resonance_wavelength')"
        },
        "paper_value": {
          "type": "string",
          "description": "Value from paper (with units)"
        },
        "simulation_value": {
          "type": "string",
          "description": "Value from simulation (with units)"
        },
        "difference_percent": {
          "type": "number",
          "description": "Percent difference"
        },
        "classification": {
          "type": "string",
          "enum": ["excellent", "acceptable", "investigate"],
          "description": "Classification based on thresholds"
        },
        "likely_cause": {
          "type": "string",
          "description": "Hypothesized reason for discrepancy"
        },
        "action_taken": {
          "type": "string",
          "description": "What was done about this discrepancy"
        },
        "blocking": {
          "type": "boolean",
          "description": "Whether this blocks further progress"
        }
      }
    },
    
    "user_interaction": {
      "type": "object",
      "required": ["id", "timestamp", "interaction_type", "context"],
      "description": "A logged user decision or feedback during reproduction",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique interaction ID (e.g., 'U1', 'U2')"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When the interaction occurred"
        },
        "interaction_type": {
          "type": "string",
          "enum": ["material_checkpoint", "clarification", "trade_off_decision", "parameter_confirmation", "stop_decision", "backtrack_approval", "context_overflow", "general_feedback"],
          "description": "Type of user interaction"
        },
        "context": {
          "type": "object",
          "description": "Context when user was asked",
          "properties": {
            "stage_id": {
              "type": ["string", "null"],
              "description": "Stage during which interaction occurred"
            },
            "agent": {
              "type": "string",
              "description": "Agent that triggered the interaction (e.g., 'SupervisorAgent')"
            },
            "reason": {
              "type": "string",
              "description": "Why user input was requested"
            }
          }
        },
        "question": {
          "type": "string",
          "description": "Question posed to user"
        },
        "user_response": {
          "type": "string",
          "description": "User's response/decision"
        },
        "impact": {
          "type": "string",
          "description": "How this decision affected the reproduction (e.g., 'Proceeded with Palik Al data')"
        },
        "alternatives_considered": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Other options that were presented to user"
        }
      }
    }
  },
  
  "example": {
    "paper_id": "aluminum_nanoantenna_2013",
    "total_runtime_seconds": 487,
    
    "stages": [
      {
        "stage_id": "stage0_material_validation",
        "stage_type": "MATERIAL_VALIDATION",
        "status": "completed_success",
        "last_updated": "2025-11-29T10:00:00Z",
        "revision_count": 1,
        "runtime_seconds": 12,
        "summary": "Al and J-aggregate optical properties validated against paper Fig 2a",
        "outputs": [
          {
            "type": "data",
            "filename": "al_nano_stage0_Al_nk.csv",
            "description": "Al n,k vs wavelength from Palik",
            "target_figure": null,
            "result_status": "success"
          },
          {
            "type": "plot",
            "filename": "al_nano_stage0_jagg_absorption.png",
            "description": "J-aggregate absorption spectrum comparison to Fig 2a",
            "target_figure": "Fig2a",
            "result_status": "success",
            "comparison_notes": "Peak at 589nm (paper: 590nm), FWHM 52meV (paper: ~50meV)"
          }
        ],
        "discrepancies": [],
        "issues": [],
        "next_actions": ["Proceed to stage1_single_disk"]
      },
      {
        "stage_id": "stage1_single_disk",
        "stage_type": "SINGLE_STRUCTURE",
        "status": "completed_partial",
        "last_updated": "2025-11-29T10:15:00Z",
        "revision_count": 2,
        "runtime_seconds": 145,
        "summary": "Single disk resonance reproduced with 4% wavelength shift due to 2D approximation",
        "outputs": [
          {
            "type": "data",
            "filename": "al_nano_stage1_D75_spectrum.csv",
            "description": "Transmission vs wavelength for D=75nm disk",
            "target_figure": "Fig3a",
            "result_status": "partial"
          },
          {
            "type": "plot",
            "filename": "al_nano_stage1_D75_transmission.png",
            "description": "Single disk transmission spectrum",
            "target_figure": "Fig3a",
            "result_status": "partial",
            "comparison_notes": "Peak shape matches, position shifted ~4% red"
          }
        ],
        "discrepancies": [
          {
            "id": "D1",
            "figure": "Fig3a",
            "quantity": "resonance_wavelength",
            "paper_value": "520 nm",
            "simulation_value": "540 nm",
            "difference_percent": 3.8,
            "classification": "acceptable",
            "likely_cause": "2D cross-section approximation ignores 3D depolarization; Palik Al data may differ from actual sample",
            "action_taken": "Documented as systematic shift; proceeding with understanding that all resonances may be ~4% red-shifted",
            "blocking": false
          }
        ],
        "issues": [
          "2D approximation causes ~4% systematic red-shift",
          "May need 3D validation for final publication-quality results"
        ],
        "next_actions": [
          "Accept as baseline and proceed to diameter sweep",
          "Optional: run one 3D validation for D=75nm to quantify 2D error"
        ]
      },
      {
        "stage_id": "stage2_bare_disk_sweep",
        "stage_type": "PARAMETER_SWEEP",
        "status": "completed_success",
        "last_updated": "2025-11-29T10:30:00Z",
        "revision_count": 1,
        "runtime_seconds": 180,
        "summary": "Diameter sweep reproduces Fig 3a trends; systematic ~4% shift consistent with Stage 1",
        "outputs": [
          {
            "type": "data",
            "filename": "al_nano_stage2_sweep_spectra.csv",
            "description": "Transmission vs wavelength for D=60,75,90,105nm",
            "target_figure": "Fig3a",
            "result_status": "success"
          },
          {
            "type": "plot",
            "filename": "al_nano_stage2_fig3a_reproduction.png",
            "description": "Multi-diameter transmission plot matching Fig 3a format",
            "target_figure": "Fig3a",
            "result_status": "success",
            "comparison_notes": "All trends correct; blue-shift with decreasing diameter; systematic ~4% offset documented"
          }
        ],
        "discrepancies": [
          {
            "id": "D2",
            "figure": "Fig3a",
            "quantity": "resonance_trend",
            "paper_value": "blue-shift with decreasing D",
            "simulation_value": "blue-shift with decreasing D",
            "difference_percent": 0,
            "classification": "excellent",
            "likely_cause": "N/A - matches",
            "action_taken": "None needed",
            "blocking": false
          }
        ],
        "issues": [],
        "next_actions": ["Proceed to stage3_coated_single"]
      },
      {
        "stage_id": "stage3_coated_single",
        "stage_type": "SINGLE_STRUCTURE",
        "status": "not_started",
        "last_updated": "2025-11-29T10:00:00Z",
        "revision_count": 0,
        "summary": "Planned: Add J-aggregate coating and validate Rabi splitting",
        "outputs": [],
        "discrepancies": [],
        "issues": [],
        "next_actions": ["Design conformal coating geometry", "Run single coated disk simulation"]
      },
      {
        "stage_id": "stage4_dispersion",
        "stage_type": "PARAMETER_SWEEP",
        "status": "not_started",
        "last_updated": "2025-11-29T10:00:00Z",
        "revision_count": 0,
        "summary": "Planned: Create dispersion diagram from diameter sweep with coating",
        "outputs": [],
        "discrepancies": [],
        "issues": [],
        "next_actions": ["Wait for stage3 completion"]
      }
    ],
    
    "discrepancy_summary": {
      "total_discrepancies": 2,
      "blocking_discrepancies": 0,
      "systematic_shifts_identified": [
        "~4% red-shift from 2D approximation (affects all resonance wavelengths)"
      ]
    },
    
    "user_interactions": [
      {
        "id": "U1",
        "timestamp": "2025-11-29T10:05:00Z",
        "interaction_type": "material_checkpoint",
        "context": {
          "stage_id": "stage0_material_validation",
          "agent": "SupervisorAgent",
          "reason": "Mandatory material validation checkpoint after Stage 0"
        },
        "question": "Material Validation Checkpoint: Al optical properties from Palik show n=0.5-1.2, k=5-8 in 400-800nm range. J-aggregate absorption peak at 589nm (paper: 590nm). Do you approve these materials for simulation?",
        "user_response": "Approved. Palik Al data is appropriate for this wavelength range.",
        "impact": "Proceeded with Palik Al optical constants for all subsequent stages",
        "alternatives_considered": [
          "Johnson-Christy Al data",
          "Rakic Al model"
        ]
      },
      {
        "id": "U2",
        "timestamp": "2025-11-29T10:20:00Z",
        "interaction_type": "trade_off_decision",
        "context": {
          "stage_id": "stage1_single_disk",
          "agent": "SupervisorAgent",
          "reason": "4% wavelength shift observed; user decision needed on acceptable tolerance"
        },
        "question": "Stage 1 shows 4% red-shift in resonance wavelength (540nm vs paper 520nm). This is likely due to 2D approximation. Options: (A) Accept and proceed, documenting as systematic shift. (B) Switch to 3D simulation (10x slower). (C) Try alternative material data.",
        "user_response": "Option A - Accept the 4% shift as a known limitation of 2D simulations. Document it and proceed.",
        "impact": "Accepted ~4% systematic shift; all subsequent resonance comparisons account for this offset",
        "alternatives_considered": [
          "Switch to 3D simulation",
          "Try Rakic Al model",
          "Adjust geometry parameters"
        ]
      }
    ]
  }
}

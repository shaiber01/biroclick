{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "plan_schema.json",
  "title": "Paper Reproduction Plan",
  "description": "Schema for _artifact_plan.json files (artifact naming: underscore prefix indicates output-only)",
  
  "type": "object",
  "required": ["paper_id", "paper_domain", "title", "summary", "targets", "stages"],
  
  "properties": {
    "paper_id": {
      "type": "string",
      "description": "Unique identifier for the paper (e.g., 'aluminum_nanoantenna_2013')"
    },
    
    "paper_domain": {
      "type": "string",
      "enum": ["plasmonics", "photonic_crystal", "metamaterial", "thin_film", "waveguide", "strong_coupling", "nonlinear", "other"],
      "description": "Primary domain of the paper"
    },
    
    "title": {
      "type": "string",
      "description": "Paper title"
    },
    
    "summary": {
      "type": "string",
      "description": "Brief 1-2 sentence summary of the physical system and main claims"
    },
    
    "main_system": {
      "type": "string",
      "description": "Description of the physical system being studied"
    },
    
    "main_claims": {
      "type": "array",
      "items": {"type": "string"},
      "description": "List of key claims to verify from the paper"
    },
    
    "simulation_approach": {
      "type": "string",
      "description": "High-level simulation approach (e.g., 'FDTD with Meep')"
    },
    
    "reproduction_scope": {
      "type": "object",
      "description": "Overview of which figures are being reproduced and which are skipped",
      "properties": {
        "total_figures": {
          "type": "integer",
          "description": "Total number of figures in the paper"
        },
        "reproducible_figures": {
          "type": "integer",
          "description": "Number of figures that could be reproduced with Meep FDTD"
        },
        "attempted_figures": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Figure IDs that will be attempted"
        },
        "skipped_figures": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "figure_id": {"type": "string"},
              "reason": {"type": "string"},
              "classification": {
                "type": "string",
                "enum": ["not_reproducible", "reproducible_other", "out_of_scope", "low_priority"]
              }
            },
            "required": ["figure_id", "reason", "classification"]
          },
          "description": "Figures not being attempted with reasons"
        },
        "coverage_percent": {
          "type": "number",
          "description": "Percentage of reproducible figures being attempted"
        }
      }
    },
    
    "extracted_parameters": {
      "type": "array",
      "description": "All parameters extracted from the paper with provenance",
      "items": {
        "type": "object",
        "required": ["name", "value", "unit", "source"],
        "properties": {
          "name": {
            "type": "string",
            "description": "Parameter name (e.g., 'disk_diameter')"
          },
          "value": {
            "oneOf": [
              {"type": "number"},
              {"type": "string"},
              {"type": "array", "items": {"type": "number"}}
            ],
            "description": "Parameter value or range"
          },
          "unit": {
            "type": "string",
            "description": "Unit (e.g., 'nm', 'eV', 'meV')"
          },
          "source": {
            "type": "string",
            "enum": ["text", "figure_caption", "figure_axis", "supplementary", "inferred"],
            "description": "Where the value was found"
          },
          "location": {
            "type": "string",
            "description": "Specific location in paper"
          },
          "cross_checked": {
            "type": "boolean",
            "description": "Whether value was verified across multiple sources"
          },
          "discrepancy_notes": {
            "type": ["string", "null"],
            "description": "Notes if sources disagree"
          }
        }
      }
    },
    
    "targets": {
      "type": "array",
      "description": "Figures/results to reproduce",
      "items": {
        "type": "object",
        "required": ["figure_id", "description", "type", "simulation_class"],
        "properties": {
          "figure_id": {
            "type": "string",
            "description": "Figure identifier (e.g., 'Fig3a')"
          },
          "description": {
            "type": "string",
            "description": "What the figure shows"
          },
          "type": {
            "type": "string",
            "enum": ["spectrum", "dispersion", "field_map", "parameter_sweep", "other"],
            "description": "Type of visualization"
          },
          "simulation_class": {
            "type": "string",
            "enum": ["FDTD_DIRECT", "FDTD_DERIVED", "ANALYTICAL", "COMPLEX_PHYSICS", "NOT_REPRODUCIBLE"],
            "description": "Classification for reproducibility"
          },
          "complexity_notes": {
            "type": ["string", "null"],
            "description": "Any special considerations"
          },
          "precision_requirement": {
            "type": "string",
            "enum": ["excellent", "good", "acceptable", "qualitative"],
            "default": "good",
            "description": "Required precision: excellent (<2%), good (<5%), acceptable (<10%), qualitative (visual only). ENFORCED RULE: 'excellent' requires digitized_data_path to be set."
          },
          "digitized_data_path": {
            "type": ["string", "null"],
            "default": null,
            "description": "Path to CSV/JSON of digitized (x,y) reference points. REQUIRED if precision_requirement='excellent'. Validated by validate_plan_targets_precision() - plans with 'excellent' precision but no digitized data will be rejected. Can be created using WebPlotDigitizer."
          }
        }
      }
    },
    
    "stages": {
      "type": "array",
      "description": "Ordered list of reproduction stages",
      "items": {
        "type": "object",
        "required": ["stage_id", "stage_type", "name", "description", "targets", "dependencies"],
        "properties": {
          "stage_id": {
            "type": "string",
            "description": "Unique stage identifier (e.g., 'stage0_material_validation')"
          },
          "stage_type": {
            "type": "string",
            "enum": ["MATERIAL_VALIDATION", "SINGLE_STRUCTURE", "ARRAY_SYSTEM", "PARAMETER_SWEEP", "COMPLEX_PHYSICS"],
            "description": "Stage category in validation hierarchy"
          },
          "name": {
            "type": "string",
            "description": "Human-readable stage name"
          },
          "description": {
            "type": "string",
            "description": "What will be done in this stage"
          },
          "targets": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Figure IDs this stage aims to reproduce"
          },
          "dependencies": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Stage IDs that must complete first"
          },
          "is_mandatory_validation": {
            "type": "boolean",
            "default": false,
            "description": "Whether this is a required validation stage"
          },
          "complexity_class": {
            "type": "string",
            "enum": ["analytical", "2D_light", "2D_medium", "3D_light", "3D_medium", "3D_heavy"],
            "description": "Computational complexity estimate"
          },
          "runtime_estimate_minutes": {
            "type": "number",
            "description": "Expected runtime in minutes"
          },
          "runtime_budget_minutes": {
            "type": "number",
            "description": "Maximum allowed runtime in minutes"
          },
          "max_revisions": {
            "type": "integer",
            "default": 3,
            "description": "Maximum design revisions before escalating"
          },
          "fallback_strategy": {
            "type": "string",
            "enum": ["ask_user", "simplify", "skip_with_warning"],
            "description": "What to do if stage fails or exceeds budget"
          },
          "validation_criteria": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Specific measurable criteria for success"
          },
          "expected_outputs": {
            "type": "array",
            "description": "Specification of expected output files. Code Generator MUST use these specs, Results Analyzer MUST read them.",
            "items": {
              "type": "object",
              "required": ["artifact_type", "filename_pattern", "description"],
              "properties": {
                "artifact_type": {
                  "type": "string",
                  "enum": ["spectrum_csv", "field_data_npz", "field_plot_png", "spectrum_plot_png", "dispersion_csv", "raw_h5"],
                  "description": "Type of output artifact"
                },
                "filename_pattern": {
                  "type": "string",
                  "description": "Expected filename pattern (e.g., '{paper_id}_{stage_id}_spectrum.csv')"
                },
                "description": {
                  "type": "string",
                  "description": "What data this file contains"
                },
                "columns": {
                  "type": "array",
                  "items": {"type": "string"},
                  "description": "For CSV files: column names (e.g., ['wavelength_nm', 'transmission', 'reflection'])"
                },
                "target_figure": {
                  "type": "string",
                  "description": "Which paper figure this output maps to"
                }
              }
            }
          },
          "reference_data_path": {
            "type": ["string", "null"],
            "default": null,
            "description": "[DEFERRED TO V2] Optional path to digitized reference data. Can be provided manually if available."
          }
        }
      }
    }
  },
  
  "example": {
    "paper_id": "aluminum_nanoantenna_2013",
    "paper_domain": "plasmonics",
    "title": "Aluminum nanoantenna complexes for strong coupling between J-aggregates and localized surface plasmons",
    "summary": "Study of strong coupling between Al nanodisk plasmons and J-aggregate excitons, demonstrating Rabi splitting of ~200 meV.",
    "main_system": "Aluminum nanodisk arrays on glass substrate coated with J-aggregate dye layer",
    "main_claims": [
      "Strong coupling between localized surface plasmon resonance and J-aggregate exciton",
      "Rabi splitting of approximately 200 meV",
      "Anticrossing behavior in dispersion diagram"
    ],
    "simulation_approach": "FDTD with Meep",
    
    "extracted_parameters": [
      {
        "name": "disk_diameter",
        "value": [60, 75, 90, 105],
        "unit": "nm",
        "source": "text",
        "location": "Methods section, paragraph 2",
        "cross_checked": true,
        "discrepancy_notes": null
      },
      {
        "name": "disk_height",
        "value": 30,
        "unit": "nm",
        "source": "text",
        "location": "Methods section",
        "cross_checked": false,
        "discrepancy_notes": null
      },
      {
        "name": "exciton_wavelength",
        "value": 590,
        "unit": "nm",
        "source": "figure_axis",
        "location": "Extracted from Fig 2a absorption peak",
        "cross_checked": true,
        "discrepancy_notes": "Text says 588nm, figure peak at 590nm. Using figure value."
      },
      {
        "name": "exciton_linewidth",
        "value": 50,
        "unit": "meV",
        "source": "figure_axis",
        "location": "FWHM from Fig 2a",
        "cross_checked": true,
        "discrepancy_notes": "Text says 45 meV, figure shows ~50 meV. Using figure value per Rule 1."
      }
    ],
    
    "targets": [
      {
        "figure_id": "Fig2a",
        "description": "J-aggregate absorption spectrum",
        "type": "spectrum",
        "simulation_class": "FDTD_DERIVED",
        "complexity_notes": "Need to extract Lorentzian parameters from this figure"
      },
      {
        "figure_id": "Fig3a",
        "description": "Transmission vs wavelength for bare Al nanodisks, multiple diameters",
        "type": "spectrum",
        "simulation_class": "FDTD_DIRECT",
        "complexity_notes": null
      },
      {
        "figure_id": "Fig3b",
        "description": "Transmission for coated nanodisks showing strong coupling",
        "type": "spectrum",
        "simulation_class": "FDTD_DIRECT",
        "complexity_notes": "Requires accurate exciton model"
      },
      {
        "figure_id": "Fig4",
        "description": "Dispersion diagram showing anticrossing and Rabi splitting",
        "type": "dispersion",
        "simulation_class": "FDTD_DERIVED",
        "complexity_notes": "Requires peak extraction from multiple spectra"
      }
    ],
    
    "stages": [
      {
        "stage_id": "stage0_material_validation",
        "stage_type": "MATERIAL_VALIDATION",
        "name": "Material optical properties validation",
        "description": "Validate Al optical constants (Palik) and J-aggregate Lorentzian model against paper Fig 2a absorption spectrum",
        "targets": ["Fig2a"],
        "dependencies": [],
        "is_mandatory_validation": true,
        "complexity_class": "analytical",
        "runtime_estimate_minutes": 1,
        "runtime_budget_minutes": 5,
        "max_revisions": 3,
        "fallback_strategy": "ask_user",
        "validation_criteria": [
          "J-aggregate absorption peak at 590Â±5 nm",
          "J-aggregate FWHM within 20% of paper value",
          "Al n,k data covers 400-800 nm range"
        ],
        "reference_data_path": null
      },
      {
        "stage_id": "stage1_single_disk",
        "stage_type": "SINGLE_STRUCTURE",
        "name": "Single bare Al nanodisk",
        "description": "Simulate single isolated Al nanodisk on glass substrate, validate resonance position for D=75nm",
        "targets": ["Fig3a"],
        "dependencies": ["stage0_material_validation"],
        "is_mandatory_validation": true,
        "complexity_class": "2D_light",
        "runtime_estimate_minutes": 2,
        "runtime_budget_minutes": 15,
        "max_revisions": 3,
        "fallback_strategy": "ask_user",
        "validation_criteria": [
          "Resonance wavelength within 5% of paper value for D=75nm",
          "Peak shape qualitatively similar (single dip in transmission)"
        ],
        "expected_outputs": [
          {
            "artifact_type": "spectrum_csv",
            "filename_pattern": "{paper_id}_stage1_spectrum.csv",
            "description": "Transmission and reflection spectrum vs wavelength",
            "columns": ["wavelength_nm", "transmission", "reflection", "absorption"],
            "target_figure": "Fig3a"
          },
          {
            "artifact_type": "spectrum_plot_png",
            "filename_pattern": "{paper_id}_stage1_spectrum.png",
            "description": "Plot comparing simulated transmission to paper Fig3a",
            "target_figure": "Fig3a"
          }
        ],
        "reference_data_path": null
      },
      {
        "stage_id": "stage2_bare_disk_sweep",
        "stage_type": "PARAMETER_SWEEP",
        "name": "Bare nanodisk diameter sweep",
        "description": "Sweep disk diameter (60, 75, 90, 105 nm) to reproduce Fig 3a",
        "targets": ["Fig3a"],
        "dependencies": ["stage1_single_disk"],
        "is_mandatory_validation": false,
        "complexity_class": "2D_medium",
        "runtime_estimate_minutes": 10,
        "runtime_budget_minutes": 30,
        "max_revisions": 3,
        "fallback_strategy": "simplify",
        "validation_criteria": [
          "Resonance blue-shifts with decreasing diameter",
          "Peak positions within 5% for all diameters"
        ],
        "reference_data_path": null
      },
      {
        "stage_id": "stage3_coated_single",
        "stage_type": "SINGLE_STRUCTURE",
        "name": "Single coated nanodisk",
        "description": "Add J-aggregate coating to single disk, validate Rabi splitting appears",
        "targets": ["Fig3b"],
        "dependencies": ["stage2_bare_disk_sweep", "stage0_material_validation"],
        "is_mandatory_validation": true,
        "complexity_class": "2D_medium",
        "runtime_estimate_minutes": 5,
        "runtime_budget_minutes": 20,
        "max_revisions": 3,
        "fallback_strategy": "ask_user",
        "validation_criteria": [
          "Two peaks visible (upper and lower polariton)",
          "Splitting approximately centered on exciton wavelength"
        ],
        "reference_data_path": null
      },
      {
        "stage_id": "stage4_dispersion",
        "stage_type": "PARAMETER_SWEEP",
        "name": "Dispersion diagram",
        "description": "Sweep diameter with coating, extract peak positions to create dispersion diagram",
        "targets": ["Fig4"],
        "dependencies": ["stage3_coated_single"],
        "is_mandatory_validation": false,
        "complexity_class": "2D_medium",
        "runtime_estimate_minutes": 20,
        "runtime_budget_minutes": 60,
        "max_revisions": 3,
        "fallback_strategy": "simplify",
        "validation_criteria": [
          "Anticrossing behavior visible",
          "Rabi splitting within 30% of paper value (~200 meV)"
        ],
        "reference_data_path": null
      }
    ]
  }
}



